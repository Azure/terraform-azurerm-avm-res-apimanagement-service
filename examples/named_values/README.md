# Named Values Example for API Management

This example demonstrates how to create named values in API Management, including both plain text values and Key Vault-backed secrets.

## Features

- Plain text named values
- Secret named values (encrypted at rest)
- Key Vault integration for secrets
- Named values with tags for filtering

## Usage

```terraform
module "apim_with_named_values" {
  source = "../../"

  name                = "apim-namedvalues-example"
  location            = "eastus"
  resource_group_name = azurerm_resource_group.this.name
  publisher_name      = "Contoso"
  publisher_email     = "publisher@contoso.com"
  sku_name            = "Developer_1"

  # Named Values Configuration
  named_values = {
    # Plain text configuration value
    "api-base-url" = {
      display_name = "API Base URL"
      value        = "https://api.contoso.com"
      tags         = ["configuration", "url"]
    }
    
    # Secret value (encrypted at rest in APIM)
    "api-key" = {
      display_name = "Third Party API Key"
      value        = "my-secret-api-key-value"
      secret       = true
      tags         = ["secret", "api", "production"]
    }
    
    # Key Vault backed secret
    "database-connection-string" = {
      display_name = "Database Connection String"
      secret       = true
      value_from_key_vault = {
        secret_id = "https://myvault.vault.azure.net/secrets/db-connection/abc123"
      }
      tags = ["database", "secret"]
    }
    
    # Environment indicator
    "environment" = {
      display_name = "Environment"
      value        = "development"
      tags         = ["environment"]
    }
  }

  # Enable managed identity for Key Vault access
  managed_identities = {
    system_assigned = true
  }

  enable_telemetry = true
}
```

## Using Named Values in Policies

Named values can be referenced in API Management policies using the syntax: `{{named-value-key}}`

Example policy:

```xml
<policies>
  <inbound>
    <base />
    <set-variable name="apiKey" value="{{api-key}}" />
    <set-backend-service base-url="{{api-base-url}}" />
    <set-header name="Environment" exists-action="override">
      <value>{{environment}}</value>
    </set-header>
  </inbound>
  <backend>
    <base />
  </backend>
  <outbound>
    <base />
  </outbound>
  <on-error>
    <base />
  </on-error>
</policies>
```

## Key Vault Integration Requirements

When using Key Vault integration:

1. **Managed Identity**: APIM must have a managed identity (system-assigned or user-assigned)
2. **Key Vault Access Policy**: Grant the identity "Get" and "List" permissions on secrets
3. **Secret URL**: Use the versioned secret URL format: `https://{vault-name}.vault.azure.net/secrets/{secret-name}/{version}`

Example Key Vault access policy:

```terraform
resource "azurerm_key_vault_access_policy" "apim" {
  key_vault_id = azurerm_key_vault.this.id
  tenant_id    = data.azurerm_client_config.current.tenant_id
  object_id    = module.apim_with_named_values.workspace_identity.principal_id

  secret_permissions = [
    "Get",
    "List",
  ]
}
```

## Tags and Filtering

Named values can be tagged for organizational purposes. These tags can be used to filter named values in the Azure Portal and through the API Management REST API.

Common tag patterns:
- **Environment**: `production`, `staging`, `development`
- **Type**: `configuration`, `secret`, `url`, `api-key`
- **Service**: `database`, `api`, `storage`

<!-- BEGIN_TF_DOCS -->
<!-- This section will be auto-generated by terraform-docs -->
<!-- END_TF_DOCS -->
